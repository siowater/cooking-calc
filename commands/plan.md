---

## description: 要件を再提示し、リスクを評価し、段階的な実装計画を作成します。コードに触れる前に、ユーザーの確認（CONFIRM）を「待機」します。

# Plan コマンド (Plan Command)

このコマンドは **planner** エージェントを呼び出し、コードを書く前に包括的な実装計画を作成します。

## このコマンドが行うこと

1. **要件の再提示** - 何を構築する必要があるかを明確にする
2. **リスクの特定** - 潜在的な問題やブロッカー（阻害要因）を表面化させる
3. **ステップ計画の作成** - 実装をフェーズごとに分解する
4. **確認の待機** - 進める前にユーザーの承認を受けなければならない（MUST）

## 使用するタイミング

以下の場合に `/plan` を使用してください：

* 新機能に着手する場合
* 重要なアーキテクチャ変更を行う場合
* 複雑なリファクタリングに取り組む場合
* 複数のファイル/コンポーネントが影響を受ける場合
* 要件が不明確または曖昧な場合

## 仕組み

planner エージェントは以下を行います：

1. **リクエストを分析**し、要件を明確な言葉で再提示する
2. 具体的で実行可能なステップを伴う**フェーズに分解**する
3. コンポーネント間の**依存関係を特定**する
4. **リスク**と潜在的なブロッカーを**評価**する
5. **複雑さを推定**する（高/中/低）
6. **計画を提示**し、あなたの明示的な確認を**待機**する

## 使用例

```
User: /plan マーケットが解決したときにリアルタイム通知を追加したい

Agent (planner):
# 実装計画: リアルタイムマーケット解決通知

## 要件の再提示
- ウォッチしているマーケットが解決した際にユーザーに通知を送信する
- 複数の通知チャネル（アプリ内、メール、Webhook）をサポートする
- 通知が確実に配信されることを保証する
- マーケットの結果とユーザーのポジション結果を含める

## 実装フェーズ

### フェーズ 1: データベーススキーマ
- 以下のカラムを持つ notifications テーブルを追加: id, user_id, market_id, type, status, created_at
- チャネル設定用の user_notification_preferences テーブルを追加
- パフォーマンスのために user_id と market_id にインデックスを作成

### フェーズ 2: 通知サービス
- lib/notifications.ts に通知サービスを作成
- BullMQ/Redis を使用して通知キューを実装
- 配信失敗時のリトライロジックを追加
- 通知テンプレートを作成

### フェーズ 3: 統合ポイント
- マーケット解決ロジックにフックする（ステータスが "resolved" に変わった時）
- マーケットにポジションを持つ全ユーザーをクエリする
- 各ユーザーの通知をエンキューする

### フェーズ 4: フロントエンドコンポーネント
- ヘッダーに NotificationBell コンポーネントを作成
- NotificationList モーダルを追加
- Supabaseサブスクリプションによるリアルタイム更新を実装
- 通知設定ページを追加

## 依存関係
- Redis (キュー用)
- メールサービス (SendGrid/Resend)
- Supabase リアルタイムサブスクリプション

## リスク
- HIGH (高): メール到達率 (SPF/DKIM が必要)
- MEDIUM (中): マーケットあたり1000人以上のユーザーがいる場合のパフォーマンス
- MEDIUM (中): マーケットが頻繁に解決する場合の通知スパム
- LOW (低): リアルタイムサブスクリプションのオーバーヘッド

## 推定される複雑さ: MEDIUM (中)
- バックエンド: 4-6 時間
- フロントエンド: 3-4 時間
- テスト: 2-3 時間
- 合計: 9-13 時間

**確認待ち**: この計画で進めますか？ (yes/no/modify)

```

## 重要な注意点

**重要 (CRITICAL)**: planner エージェントは、あなたが "yes" や "proceed" などの肯定的な応答で計画を明示的に確認するまで、コードを**一切書きません**。

変更を希望する場合は、以下のように応答してください：

* "modify: [変更内容]"
* "different approach: [代替案]"
* "skip phase 2 and do phase 3 first" (フェーズ2をスキップしてフェーズ3を先に実行)

## 他のコマンドとの統合

計画策定後：

* `/tdd` を使用してテスト駆動開発で実装する
* ビルドエラーが発生した場合は `/build-and-fix` を使用する
* `/code-review` を使用して完了した実装をレビューする

## 関連エージェント

このコマンドは、以下の場所にある `planner` エージェントを呼び出します：
`~/.cursor/agents/planner.md`


